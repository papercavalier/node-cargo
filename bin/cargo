#!/usr/bin/env node

const https = require('https');
const fs = require('fs');
const path = require('path');
const { Server } = require('socket.io');
const scale = require('dymo-scale');
const { exec } = require('child_process');

// --- TLS config ---
const tlsOptions = {
  key: fs.readFileSync(
    path.join(__dirname, '..', 'certs', 'cargo-local-key.pem')
  ),
  cert: fs.readFileSync(
    path.join(__dirname, '..', 'certs', 'cargo-local.pem')
  ),
};

// --- HTTPS server ---
const server = https.createServer(tlsOptions);

// --- Socket.IO ---
const io = new Server(server, {
  cors: {
    origin: true, // reflect requesting origin
    credentials: true,
  },
});

// --- Start server ---
server.listen(8080, '0.0.0.0', () => {
  console.log('node-cargo listening on https://cargo-local.test:8080');
});

// --- Socket handling ---
io.on('connection', (socket) => {
  console.log('Client connected');

  let pollTimeout;

  const readScale = () => {
    scale.read((err, data) => {
      if (!err && data) {
        socket.emit('scale', data.value);
      }

      pollTimeout = setTimeout(
        readScale,
        err ? 2000 : 100
      );
    });
  };

  readScale();

  socket.on('disconnect', () => {
    console.log('Client disconnected');
    if (pollTimeout) clearTimeout(pollTimeout);
  });

  socket.on('printer', (data) => {
    const tmpPath = `/tmp/${Date.now()}`;
    const binaryData = Buffer.from(data, 'base64');

    fs.writeFile(tmpPath, binaryData, (err) => {
      if (err) return;

      exec(`lpr -l ${tmpPath}`, () => {
        fs.unlink(tmpPath, () => {});
      });
    });
  });
});
