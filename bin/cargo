#!/usr/bin/env node

const https = require('https');
const fs = require('fs');
const path = require('path');
const { Server } = require('socket.io');
const scale = require('dymo-scale');
const { exec } = require('child_process');

// --- TLS config ---
const tlsOptions = {
  key: fs.readFileSync(path.join(__dirname, '..', 'certs', 'localhost-key.pem')),
  cert: fs.readFileSync(path.join(__dirname, '..', 'certs', 'localhost.pem')),
};

// --- HTTPS server with PNA + CORS headers ---
const server = https.createServer(tlsOptions, (req, res) => {
  // CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', '*');

  // ðŸ”‘ REQUIRED for Chrome Private Network Access
  res.setHeader('Access-Control-Allow-Private-Network', 'true');

  // Handle preflight
  if (req.method === 'OPTIONS') {
    res.writeHead(204);
    return res.end();
  }
});

// --- Socket.IO ---
const io = new Server(server, {
  cors: {
    origin: '*', // OK for now
    methods: ['GET', 'POST'],
  },
});

// --- Start server ---
server.listen(8080, () => {
  console.log('node-cargo listening on https://localhost:8080');
});

// --- Socket handling ---
io.on('connection', (socket) => {
  console.log('Client connected');

  let pollTimeout = null;

  const readScale = () => {
    scale.read((err, data) => {
      if (!err && data) {
        socket.emit('scale', data.value);
      }

      pollTimeout = setTimeout(
        readScale,
        err ? 2000 : 100
      );
    });
  };

  // Start polling immediately
  readScale();

  socket.on('disconnect', () => {
    console.log('Client disconnected');
    if (pollTimeout) clearTimeout(pollTimeout);
  });

  socket.on('printer', (data) => {
    const tmpPath = `/tmp/${Date.now()}`;
    const binaryData = Buffer.from(data, 'base64');

    fs.writeFile(tmpPath, binaryData, (err) => {
      if (err) return;

      exec(`lpr -l ${tmpPath}`, () => {
        fs.unlink(tmpPath, () => {});
      });
    });
  });
});
